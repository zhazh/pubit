{% extends 'base.html' %}

{% block nav_menu %}
{% include 'admin/_nav.html' %}
{% endblock %}

{% block main %}
<div class="sidebar">
    <ul class="nav nav-pills nav-stacked">
        <li class="active">
            <a href="{{url_for('admin.home')}}">Home</a>
        </li>
        <li><a href="#pub-folder" data-toggle="modal" data-target="#pub-folder">Pub folder now!</a></li>
    </ul>
</div>

<div class="main-content">
    <h4>Published folders.</h4>
    <table class="table table-bordered">
        <tr>
            <td>#</td>
            <td>Pub Time</td>
            <td>Access</td>
            <td>Name</td>
            <td>Password</td>
            <td>Description</td>
            <td>Base directory</td>
            <td>Path</td>
            <td>Allow upload</td>
            <td>Operation</td>
        </tr>
        {% for pub in pubs %}
        {% if pub.is_public %}
        <tr class="success">
        {% else %}
        <tr class="danger">
        {% endif %}
            <td>{{loop.index}}</td>
            <td>{{pub.standard_pubtime}}</td>
            <td>{{pub.access}}</td>
            <td>{{pub.name}}</td>
            <td>{{pub.password or ''}}</td>
            <td>{{pub.description}}</td>
            <td>{{pub.base_dir}}</td>
            <td>{{pub.path}}</td>
            <td>{{pub.allow_upload}}</td>
            <td>
                <button class="btn btn-danger btn-xs">Delete</button>
                <button class="btn btn-info btn-xs" data-toggle="modal" data-target="#modify-pub">Modify</button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- Pub folder modal -->
    <div id="pub-folder" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Publish an local folder.</h4>
                </div>
                <div class="modal-body">
                    <form name="create-pubitem">
                        <div class="form-group">
                            <label for="pubname">Pub name</label>
                            <input id="pubname" name="name" type="text" class="form-control" placeholder="Pub name">
                        </div>

                        <div class="form-group">
                            <label for="description">Pub description</label>
                            <input id="description" name="description" type="textarea" class="form-control" placeholder="Pub description">
                        </div>

                        <div class="form-group">
                            <label for="path">Pub directory</label>
                            <input id="path" name="path" type="text" class="form-control" placeholder="Pub directory" value="/" readonly>
                        </div>
                        <div id="newpub-jstree" class="modal-jstree">
                            Directory tree.
                        </div>

                        <div class="radio">
                            Pub access: 
                            <label>
                                <input type="radio" name="access" value="public" checked> Public
                            </label>
                            <label>
                                <input type="radio" name="access" value="protected"> Protected
                            </label>
                        </div>

                        <div class="form-group password disappear">
                            <label for="password">Password</label>
                            <input id="password" name="password" type="password" class="form-control" placeholder="Password">
                        </div>

                        <div class="form-group password disappear">
                            <label for="confirm_password">Confirm password</label>
                            <input id="confirm_password" name="confirm_password" type="password" class="form-control" placeholder="Input password again">
                        </div>

                        <div class="radio">
                            Allow upload: 
                            <label>
                                <input type="radio" name="allow_upload" value="yes"> Yes
                            </label>
                            <label>
                                <input type="radio" name="allow_upload" value="no" checked> No
                            </label>
                        </div>
                        <button type="submit" class="btn btn-default">Publish</button>
                    </form>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div id="modify-pub" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Modify pub</h4>
                </div>
                <div class="modal-body">
                    <form name="modify-pub">
                        <input id="pubid" name="id" type="hidden" class="form-control" value="1">
                        <div class="form-group">
                            <label for="pubname">Pub name</label>
                            <input id="pubname" name="name" type="text" class="form-control" placeholder="Pub name">
                        </div>

                        <div class="form-group">
                            <label for="description">Pub description</label>
                            <input id="description" name="description" type="textarea" class="form-control" placeholder="Pub description">
                        </div>

                        <div class="form-group">
                            <label for="path">Pub directory</label>
                            <input id="path" name="path" type="text" class="form-control" placeholder="Pub directory" value="/" readonly>
                        </div>

                        <div class="radio">
                            Pub access: 
                            <label>
                                <input type="radio" name="access" value="public" checked> Public
                            </label>
                            <label>
                                <input type="radio" name="access" value="protected"> Protected
                            </label>
                        </div>

                        <div class="form-group password disappear">
                            <label for="password">Password</label>
                            <input id="password" name="password" type="password" class="form-control" placeholder="Password">
                        </div>

                        <div class="form-group password disappear">
                            <label for="confirm_password">Confirm password</label>
                            <input id="confirm_password" name="confirm_password" type="password" class="form-control" placeholder="Input password again">
                        </div>

                        <div class="radio">
                            Allow upload: 
                            <label>
                                <input type="radio" name="allow_upload" value="yes"> Yes
                            </label>
                            <label>
                                <input type="radio" name="allow_upload" value="no" checked> No
                            </label>
                        </div>
                        <button type="submit" class="btn btn-default">Save Changes</button>
                    </form>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        // list server directories.
        $('#newpub-jstree').jstree({ 'core' : {
                'data' : {'asyn':true, 'url':"{{url_for('admin.dir_tree')}}"}
            }
        });
    
        $('#newpub-jstree').on("changed.jstree", function (e, data) {
            url = data.selected[0];
            $("input[name='path']").val(url);
        });

        $("input[name='access']").click(function(){
            console.log($(this).val());
            if ($(this).val() === 'public') {
                $("div.password").addClass("disappear");
                $("#password").attr("disabled", true);
                $("#confirm_password").attr("disabled", true);
            } else {
                $("div.password").removeClass("disappear");
                $("#password").attr("disabled", false);
                $("#confirm_password").attr("disabled", false);
            }
        });

        $("form[name='create-pubitem']").validate({
            rules: {
                name: "required",
                path: "required",
                password: {
                    required: true,
                    rangelength: [5, 20],
                },

                confirm_password: {
                    equalTo: '#password',
                },
            },
            messages: {
                name: "Empty pub name.",
                path: "Path required.",
                password: {
                    required: 'Empty password.',
                    rangelength: 'Length between 5 and 20.',
                },
                confirm_password: {
                    equalTo: 'Not equal to password.',
                },
            }
        });

        $("form[name='create-pubitem']").submit(function(e){
            if (!$(this).valid()) {
                e.preventDefault();
                return;
            }

            $.post("{{url_for('admin.new_pub')}}", 
                    $(this).serialize(), 
                    function(data) {
                        if (data.code == 0) {
                            alert("Publish an folder success.");
                            window.location.reload();
                        } else {
                            alert("Create new user occurred an error:" + data.msg);
                        }
                    }, "json"
            );
            $("#pub-folder").modal('hide');
            e.preventDefault();
            $(this)[0].reset();
        });
    });
</script>
{% endblock %}