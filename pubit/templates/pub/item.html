{% extends 'base.html' %}

{% block nav_menu %}
<ul class="nav navbar-nav navbar-right">
    <li>
        <a href="{{url_for('pub.logout')}}">Sign out</a>
    </li>
</ul>
<ul class="nav navbar-form navbar-right">
    <li><input name="search" type="text" placeholder="Search file in pub..." class="form-control"></li>
</ul>
{% endblock %}

{% block main %}
<div class="sidebar">
    <div name="pubitem-dir-tree"></div>
</div>

<div class="main-content">
    {% if pub.allow_upload %}
    <div class="toolbar">Upload tool</div>
    {% endif %}
    <div id="pubitem-list-nav" class="nav">nav</div>
    <div id="pubitem-list" uuid="{{pub.uuid}}">
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        // pubitem directory select jstree initialize.
        $("div[name='pubitem-dir-tree']").jstree({
            'core' : {
                'data' : {'asyn':true, 'url':"{{url_for('api.item', uuid=pub.uuid)}}"}
            }
        });

        // pubitem directory select jstree changed.
        $("div[name='pubitem-dir-tree']").on("changed.jstree", function (e, data) {
            url = data.selected[0];
            load_pubs(url);
            //$("form[name='pub-create']").find("input[name='path']").val(url);
        });

        show_pubs = function(pubs){
            var table = $("<table class='table'></table>");
            var tab_head = $("<tr><td>#</td><td>Create time</td><td>Name</td><td>Size</td></tr>");
            table.append(tab_head);
            for (i=0; i<pubs.length; i++) {
                var item = $('<tr></tr>');
                var type=$('<td>' + pubs[i].type + '</td>');
                var create = $('<td>' + pubs[i].create + '</td>');
                if (pubs[i].type === 'dir') {
                    var on_click = "onclick=\"load_pubs('"+ pubs[i].path + "');\"";
                    var href = $("<a href='javasrcipt:void(0)' "+ on_click + ">" + pubs[i].name + "</a>");
                    var name = $('<td></td>');
                    name.append(href);
                } else {
                    var name = $('<td>' + pubs[i].name + '</td>');
                }
                var size = $('<td>' + pubs[i].size + '</td>');
                item.append(type);
                item.append(create);
                item.append(name);
                item.append(size);
                table.append(item);
            }
            $("#pubitem-list").empty();
            $("#pubitem-list").append(table);
        };

        load_pubs = function(url) {
            $('#pubitem-list-nav').empty();
            $('#pubitem-list-nav').append(url);
            $.get(
                "{{url_for('api.item', uuid=pub.uuid)}}",
                {path: url},
                function(data){
                    show_pubs(data);
                }, 
                "json"
            );
        };

        // get root dirctory file and dir list.
        load_pubs("/");
    });
</script>
{% endblock %}