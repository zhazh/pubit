{% extends 'base.html' %}

{% block nav_menu %}
<ul class="nav navbar-nav navbar-right">
    <li>
        <a href="{{url_for('pub.logout')}}">Sign out</a>
    </li>
</ul>
<ul class="nav navbar-form navbar-right">
    <li><input name="search" type="text" placeholder="Search file in pub..." class="form-control"></li>
</ul>
{% endblock %}

{% block main %}
<div class="sidebar">
    <div name="pubitem-dir-tree"></div>
</div>

<div class="main-content">
    {% if pub.allow_upload %}
    <div class="pub-toolbar">
        <button class="btn btn-sm btn-success" role="pub-upload">Upload</button>
    </div>
    {% endif %}
    <div id="pub-path-nav" class="pub-path">
        <!-- dynamic create path nav. -->
    </div>
    <div id="pub-nodes" class="pub-nodes">
        <!-- dynamic load pub nodes to here. -->
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        // pubitem directory select jstree initialize.
        $("div[name='pubitem-dir-tree']").jstree({
            'core' : {
                'data' : {'asyn':true, 'url':"{{url_for('api.item', uuid=pub.uuid)}}"}
            }
        });
        // pubitem directory select jstree changed.
        $("div[name='pubitem-dir-tree']").on("changed.jstree", function (e, data) {
            url = data.selected[0];
            load_nodes(url);
            //$("form[name='pub-create']").find("input[name='path']").val(url);
        });

        update_path_nav = function(url) {
            url_arr = url.split('/');
            if (url_arr.length == 2 && url_arr[1] == '') {
                delete url_arr[0];
            }
            var breadcrumb = $("<ol class='breadcrumb'></ol>");
            for (i=0; i<url_arr.length; i++) {
                var li = $('<li></li>');
                if(i==0) {
                    var href = $("<a href=\"javascript:void(0);\" onclick=\"load_nodes('/');\">Home</a>");
                } else {
                    var path = '';
                    for (j=1; j<=i; j++) {
                        path = path + '/' + url_arr[j];
                    }
                    var href = $("<a href=\"javascript:void(0);\" onclick=\"load_nodes('"+ path + "');\">" + url_arr[i] + "</a>");
                }
                li.append(href);
                breadcrumb.append(li);
            }
            $('#pub-path-nav').empty();
            $('#pub-path-nav').append(breadcrumb);
        };

        // requried function: load_nodes(url).
        show_nodes = function(nodes) {
            var table = $("<table class='table'></table>");
            var tab_head = $("<tr><td>Name</td><td>Type</td><td>Create time</td><td>Size</td></tr>");
            table.append(tab_head);
            for (i=0; i<nodes.length; i++) {
                var item = $('<tr></tr>');
                var type=$('<td>' + nodes[i].type[1] + '</td>');
                var create = $('<td>' + nodes[i].create + '</td>');
                if (nodes[i].type[1].toLowerCase() === 'directory') {
                    var on_click = "onclick=\"load_nodes('"+ nodes[i].path + "');\"";
                    var href = $("<a href='javasrcipt:void(0)' "+ on_click + ">" + nodes[i].name + "</a>");
                    var name = $('<td></td>');
                    name.append(href);
                } else {
                    //Downlaod link.
                    var uuid = "{{pub.uuid}}";
                    var path = nodes[i].path;
                    var href = $("<a href=\"/pub/download/"+uuid+"?path="+path+"\">" + nodes[i].name + "</a>");
                    var name = $('<td></td>');
                    name.append(href);
                }
                var size = $('<td>' + nodes[i].size + '</td>');
                item.append(name);
                item.append(type);
                item.append(create);
                item.append(size);
                table.append(item);
            }
            $("#pub-nodes").empty();
            $("#pub-nodes").append(table);
        };

        load_nodes = function(url) {
            $('#pubs-dir-path').empty();
            $('#pubs-dir-path').append(url);
            update_path_nav(url);
            $.get(
                "{{url_for('api.item', uuid=pub.uuid)}}",
                {path: url},
                function(nodes){
                    show_nodes(nodes);
                }, 
                "json"
            );
        };

        // get root dirctory file and dir list.
        load_nodes("/");
    });
</script>
{% endblock %}