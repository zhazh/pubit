{% extends 'base.html' %}

{% block nav_menu %}
<ul class="nav navbar-nav navbar-right">
    <li>
        <a href="{{url_for('pub.logout')}}">Sign out</a>
    </li>
</ul>
{% endblock %}

{% block main %}
<div class="sidebar">
    <div name="pub-sidemenu">
        <!-- dynamic load this pub directory tree.-->
    </div>
</div>

<div class="main-content">
    <div class="pub-toolbar">
        <ul>
            <li><a name="nav-back" class="btn btn-default" href="javascript:void(0);">Back</a></li>
            {% if pub.allow_upload %}
            <li class="dropdown">
                <a href="javascript:;" class="dropdown-toggle btn btn-primary" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                    Upload<span class="caret"></span> 
                </a>
                <ul class="dropdown-menu">
                    <li><a href="javascript:;">File</a></li>
                    <li><a href="javascript:;">Folder</a></li>
                </ul>
            </li>
            <li><a name="create-folder" href="javascript:;" class="btn btn-default">New folder</a></li>
            {% endif %}
        </ul>
        <form name="pub-search", method="GET">
            <input name="keywords" type="text" placeholder="Search file in pub..." class="form-control">
        </form>
    </div>
    
    <div class="pub-main" uuid="{{pub.uuid}}">
        <div name="pub-path" class="pub-path">
            <!-- dynamic create path nav. -->
        </div>
        <div class="collapse-toolbar">
            <button class="btn btn-xs btn-default" role="download">Download</button>
            {% if pub.allow_upload %}
            <button class="btn btn-xs btn-default" role="delete">Delete</button>
            <button class="btn btn-xs btn-default" role="rename">Rename</button>
            {% endif %}
        </div>
        <div name="pub-nodes" class="pub-nodes">
            <!-- dynamic load pub nodes to here. -->
        </div>

        <!-- show text modal. -->
        <div name="open-text" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h5 class="modal-title"></h5>
                    </div>
                    <div class="modal-body">
                        <!-- dynamic load content. -->
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <!-- play audio modal. -->
        <div name="audio-player" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <audio name="audio-player" src="" controls="controls" autoplay></audio>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <!-- play video modal. -->
        <div name="video-player" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <video name="video-player" src="" controls="controls" autoplay></video>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <!-- show image modal. -->
        <div name="image" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <img src="" />
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        {% if pub.allow_upload %}
        <div name="create-folder" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h5 class="modal-title">Create an folder.</h5>
                    </div>
                    <div class="modal-body">
                        <form name="create-folder">
                            <input name="parent_path" type="hidden" class="form-control" value="">
                            <div class="form-group">
                                <label>Folder name</label>
                                <input name="name" type="text" class="form-control" placeholder="Folder name" value="New folder">
                            </div>
                            <button type="submit" class="btn btn-default">Submit</button>
                        </form>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    var uuid = "{{pub.uuid}}";
    node_table = new NodeTable(uuid);

    $(document).ready(function(){
        // show pub root nodes at start.
        node_table.load('/');

        // pub side-menu tree init.
        $("div[name='pub-sidemenu']").jstree({
            'core' : {
                'data' : {'asyn':true, 'url':"{{url_for('api.nodes', uuid=pub.uuid)}}"}
            }
        });
        
        // pub side-menu tree selected.
        $("div[name='pub-sidemenu']").on("changed.jstree", function (e, data) {
            url = data.selected[0];
            node_table.load(url);
        });

        // search files in this pub.
        $("form[name='pub-search']").on("submit", function(e){
            $.get(
                "{{url_for('api.search', uuid=pub.uuid)}}",
                $(this).serialize(),
                function(nodes){
                    node_table.show(nodes, 1);
                    $("input[name='keywords']").val('');
                }, 
                "json"
            );
            return false;
        });

        // listen path-link click then load and show the path nodes.
        $("div.pub-nodes").on("click", "a[name='path-link']", function(e){
            var path = $(this).attr('path');
            node_table.load(path);
            e.stopPropagation();
        });

        // To navgation back.
        $("a[name='nav-back']").on('click', function(){
            node_table.nav_back();
        });

        // table-nodes-row selected.
        $("div.pub-main").on("click", function(e){
            var ev = e || window.event;
            var target = ev.target || ev.srcElement;
            if ($(target).is('.table-nodes-col')) {
                // table-row clicked.
                var row = $(target).parent();
                if ($(row).hasClass('table-nodes-head')) {
                    // skip table-nodes-head.
                    return;
                }
                $(row).addClass('active');
                $(row).siblings().removeClass('active');
                $("div.collapse-toolbar").slideDown();
            } else {
                if ($(target).is(".collapse-toolbar")) {
                    // skip .collapse-toolbar click.
                    return;
                }
                $("div.collapse-toolbar").slideUp();
            }
        });

        // double click to open node(play audio/video).
        $("div.pub-nodes").on("dblclick", ".table-nodes-row", function(e){
            if ($(this).hasClass('table-nodes-head')) {
                // skip: .table-nodes-head.
                return;
            }
            var name = $(this).attr('name');
            var type = $(this).attr('type');
            var uuid = $(this).attr("uuid");
            var url = $(this).attr('path');
            console.log(name);
            if (type === 'directory') {
                node_table.load(url);
            } else {
                // open support file type.
                if (type === 'text file') {
                    // open text file.
                    $.get("/pub/text/"+uuid+"?path="+url,
                        function(data,status){
                            var content = $('<div>' + data + '</div>');
                            $(".modal[name='open-text']").children('.modal-dialog').children('.modal-content').children('.modal-header').children('.modal-title').html(name);
                            $(".modal[name='open-text']").children('.modal-dialog').children('.modal-content').children('.modal-body').empty();
                            $(".modal[name='open-text']").children('.modal-dialog').children('.modal-content').children('.modal-body').append(content);
                            $(".modal[name='open-text']").modal('show');     
                    });
                } else if (type === 'audio file') {
                    var download_url = "/pub/download/"+uuid+"?path="+url;
                    $(".modal[name='audio-player']").children('.modal-dialog').children('.modal-content').children('.modal-body').children('audio').attr('src', download_url);
                    $(".modal[name='audio-player']").modal('show'); 
                } else if (type === 'video file') {
                    var download_url = "/pub/download/"+uuid+"?path="+url;
                    $(".modal[name='video-player']").children('.modal-dialog').children('.modal-content').children('.modal-body').children('video').attr('src', download_url);
                    $(".modal[name='video-player']").modal('show');
                } else if (type === 'photo') {
                    var download_url = "/pub/download/"+uuid+"?path="+url;
                    $(".modal[name='image']").children('.modal-dialog').children('.modal-content').children('.modal-body').children('img').attr('src', download_url);
                    $(".modal[name='image']").modal('show');
                } else {
                    alert("Not support open.");
                }
            }
        });

        // when audio-player dismiss stop audio playing.
        $(".modal[name='audio-player']").on("hide.bs.modal", function(e){
            $(".modal[name='audio-player']").children('.modal-dialog').children('.modal-content').children('.modal-body').children('audio')[0].pause();
        });

        // when video-player dismiss stop video playing.
        $(".modal[name='video-player']").on("hide.bs.modal", function(e){
            $(".modal[name='video-player']").children('.modal-dialog').children('.modal-content').children('.modal-body').children('video')[0].pause();
        });

        // download file or directory.
        $("button[role='download']").on("click", function(e){
            var selected_row = $("div.table-nodes").children(".active");
            if (selected_row.length == 1) {
                var type = $(selected_row).attr("type");
                var uuid = $(selected_row).attr("uuid");
                var path = $(selected_row).attr("path");
                if (type === "directory") {
                    // directory download.
                    window.location.href = "/pub/download/"+uuid+"?path="+path;
                } else {
                    // file download.
                    window.location.href = "/pub/download/"+uuid+"?path="+path;
                }
            } else {
                alert("Unselected item!");
            }
            e.stopPropagation();
        });
    });
</script>

{% if pub.allow_upload %}
<script>
    $(document).ready(function(){

        $("form[name='create-folder']").validate({
            rules: {
                name: "required",
            },
            messages: {
                name: "Empty folder name.",
            }
        });

        // Create folder.
        $("a[name='create-folder']").on('click', function(){
            var current_url = node_table.current_url();
            $(".modal[name='create-folder']").find("input[name='parent_path']").val(current_url);
            $(".modal[name='create-folder']").modal("show");
        });

        $("form[name='create-folder']").on('submit', function(e){
            if (!$(this).valid()) {
                e.preventDefault();
                return;
            }
            $.post("/api/pub/" + node_table.uuid + "/node", 
                    $(this).serialize(), 
                    function(data) {
                        if (data.code == 0) {
                            alert("Create folder success.");
                            node_table.reload();
                        } else {
                            alert("Failed to create folder:" + data.msg);
                        }
                    }, "json"
            );
            $(".modal[name='create-folder']").modal("hide");
            e.preventDefault();
            $(this)[0].reset();
        });
    });
</script>
{% endif %}

{% endblock %}