{% extends 'base.html' %}

{% block nav_menu %}
<ul class="nav navbar-nav navbar-right">
    <li>
        <a href="{{url_for('pub.logout')}}">Sign out</a>
    </li>
</ul>
{% endblock %}

{% block main %}
<div class="sidebar">
    <div name="pubitem-dir-tree"></div>
</div>

<div class="main-content">
    <div class="pub-toolbar">
        <ul>
            <li><a name="nav-back" class="btn btn-default" href="javascript:void(0);">Back</a></li>
            {% if pub.allow_upload %}
            <li class="dropdown">
                <a href="javascript:;" class="dropdown-toggle btn btn-primary" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                    Upload<span class="caret"></span> 
                </a>
                <ul class="dropdown-menu">
                    <li><a href="javascript:;">File</a></li>
                    <li><a href="javascript:;">Folder</a></li>
                </ul>
            </li>
            <li><a name="create-folder" href="javascript:;" class="btn btn-default">New folder</a></li>
            {% endif %}
        </ul>
        <form name="pub-search", method="GET">
            <input name="keywords" type="text" placeholder="Search file in pub..." class="form-control">
        </form>
    </div>
    
    <div class="pub-main" uuid="{{pub.uuid}}">
        <div id="pub-path-nav" class="pub-path">
            <!-- dynamic create path nav. -->
        </div>
        <div class="collapse-toolbar">
            <button class="btn btn-xs btn-default" role="download">Download</button>
            {% if pub.allow_upload %}
            <button class="btn btn-xs btn-default" role="delete">Delete</button>
            <button class="btn btn-xs btn-default" role="rename">Rename</button>
            {% endif %}
        </div>
        <div id="pub-nodes" class="pub-nodes">
            <!-- dynamic load pub nodes to here. -->
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        // pubitem directory select jstree initialize.
        $("div[name='pubitem-dir-tree']").jstree({
            'core' : {
                'data' : {'asyn':true, 'url':"{{url_for('api.nodes', uuid=pub.uuid)}}"}
            }
        });
        // pubitem directory select jstree changed.
        $("div[name='pubitem-dir-tree']").on("changed.jstree", function (e, data) {
            url = data.selected[0];
            load_nodes(url);
        });

        update_path_nav = function(url) {
            url_arr = url.split('/');
            if (url_arr.length == 2 && url_arr[1] == '') {
                delete url_arr[0];
            }
            var breadcrumb = $("<ol class='breadcrumb'></ol>");
            for (i=0; i<url_arr.length; i++) {
                var li = $('<li></li>');
                if(i==0) {
                    var href = $("<a href=\"javascript:void(0);\" onclick=\"load_nodes('/');\">Home</a>");
                } else {
                    var path = '';
                    for (j=1; j<=i; j++) {
                        path = path + '/' + url_arr[j];
                    }
                    var href = $("<a href=\"javascript:void(0);\" onclick=\"load_nodes('"+ path + "');\">" + url_arr[i] + "</a>");
                }
                li.append(href);
                breadcrumb.append(li);
            }
            $('#pub-path-nav').empty();
            $('#pub-path-nav').append(breadcrumb);
        };

        // requried function: load_nodes(url).
        // nodes: node array.
        // style: 0: show node list(default), 1: show search result.
        show_nodes = function(nodes, style) {
            style = style || 0;
            var table = $("<div class='table-nodes'></div>");
            
            var tab_head = $("<div class='table-nodes-row table-nodes-head'></div>");

            var dir_head = $("<div class='table-nodes-col'>Directory</div>");
            var name_head = $("<div class='table-nodes-col'>Name</div>");
            var type_head = $("<div class='table-nodes-col'>Type</div>");
            var create_head = $("<div class='table-nodes-col'>Create time</div>");
            var size_head = $("<div class='table-nodes-col'>Size</div>");

            if (style == 1) {
                tab_head.append(dir_head);
            }
            tab_head.append(name_head);
            tab_head.append(type_head);
            tab_head.append(create_head);
            tab_head.append(size_head);
            table.append(tab_head);
            for (i=0; i<nodes.length; i++) {
                var uuid = "{{pub.uuid}}";
                var path = nodes[i].path;
                var node_type = nodes[i].type[1].toLowerCase();

                var item = $("<div class='table-nodes-row' type='" + node_type + "' uuid='" + uuid + "' path='" + path + "'></div>");
                var directory = $("<div class='table-nodes-col'>" + "<a href='javascript:void(0);' path='" + nodes[i].parent_path + "' name='parent-path'>" + nodes[i].parent_path + "</a>" + "</div>");
                var name = $("<div class='table-nodes-col'>" + nodes[i].name + "</div>");
                var type=$("<div class='table-nodes-col'>" + nodes[i].type[1] + "</div>");
                var create = $("<div class='table-nodes-col'>" + nodes[i].create + "</div>");
                var size = $("<div class='table-nodes-col'>" + nodes[i].size + "</div>");
                
                if (style == 1) {
                    item.append(directory);
                }
                item.append(name);
                item.append(type);
                item.append(create);
                item.append(size);
                table.append(item);
            }
            $("#pub-nodes").empty();
            $("#pub-nodes").append(table);
        };

        var url_stack = new Array();
        load_nodes = function(url) {
            $('#pubs-dir-path').empty();
            $('#pubs-dir-path').append(url);
            update_path_nav(url);
            $.get(
                "{{url_for('api.nodes', uuid=pub.uuid)}}",
                {path: url},
                function(nodes){
                    show_nodes(nodes);
                }, 
                "json"
            );
            url_stack.push(url);
            if (url_stack.length<2) {
                $("a[name='nav-back']").addClass('disabled');
            } else {
                $("a[name='nav-back']").removeClass('disabled');
            }
        };

        // get root dirctory file and dir list.
        load_nodes("/");

        $("a[name='nav-back']").on('click', function(){
            if (url_stack.length >= 2) {
                url_stack.pop();    // current page.
                var url = url_stack.pop();
                load_nodes(url);
            }
        });

        // search files in this pub.
        $("form[name='pub-search']").on("submit", function(e){
            $.get(
                "{{url_for('api.search', uuid=pub.uuid)}}",
                $(this).serialize(),
                function(nodes){
                    show_nodes(nodes, 1);
                    $("input[name='keywords']").val('');
                }, 
                "json"
            );
            return false;
        });

        $("div.pub-nodes").on("click", "a[name='parent-path']", function(e){
            var path = $(this).attr('path');
            load_nodes(path);
            e.stopPropagation();
        });


        $("div.pub-main").on("click", function(e){
            var ev = e || window.event;
            var target = ev.target || ev.srcElement;
            if ($(target).is('.table-nodes-col')) {
                // table-row clicked.
                var row = $(target).parent();
                if ($(row).hasClass('table-nodes-head')) {
                    // skip table-nodes-head.
                    return;
                }
                $(row).addClass('active');
                $(row).siblings().removeClass('active');
                $("div.collapse-toolbar").slideDown();
            } else {
                if ($(target).is(".collapse-toolbar")) {
                    // skip .collapse-toolbar click.
                    return;
                }
                $("div.collapse-toolbar").slideUp();
            }
        });

        // double click to open node(play audio/video).
        $("div.pub-nodes").on("dblclick", ".table-nodes-row", function(e){
            if ($(this).hasClass('table-nodes-head')) {
                // skip: .table-nodes-head.
                return;
            }
            var type = $(this).attr('type');
            var url = $(this).attr('path');
            if (type === 'directory') {
                load_nodes(url);
            } else {
                // open support file type.
            }
        });

        $("button[role='download']").on("click", function(e){
            var selected_row = $("div.table-nodes").children(".active");
            if (selected_row.length == 1) {
                var type = $(selected_row).attr("type");
                var uuid = $(selected_row).attr("uuid");
                var path = $(selected_row).attr("path");
                if (type === "directory") {
                    // directory download.
                } else {
                    // file download.
                    window.location.href = "/pub/download/"+uuid+"?path="+path;
                }
            } else {
                alert("Unselected item!");
            }
            e.stopPropagation();
        });
    });
</script>
{% endblock %}